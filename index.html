<html lang="en">

<head>
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection" />
    <link type="text/css" rel="stylesheet" href="css/style_extended.css" media="screen,projection" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Gag Wheel Calculator</title>
</head>

<body class="grey darken-3">
    <div class="row">
        <form class="col s12">
            <div class="row">
                <div class="input-field col s12">
                    <input id="donation_amount_uid" type="number"
                        class="white-text validate input-bottom-border bold-text" />
                    <label class="white-text" for="donation_amount_uid">Donation</label>
                </div>
                <div class="input-field col s6">
                    <input value="0" id="curr_donation_wheels_count_uid" type="number"
                        class="white-text validate input-bottom-border bold-text" />
                    <label class="white-text" for="curr_donation_wheels_count_uid">Current wheels</label>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <p>
                        <label>
                            <input id="midas_uid" type="checkbox" class="filled-in checkbox-blue-grey" />
                            <span class="white-text">Hand of Midas</span>
                        </label>
                    </p>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <a id="check_button_uid" class="waves-effect waves-light btn green darken-2">Check</a>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <input disabled value="0" id="wheels_count_uid" type="number"
                        class="white-text input-bottom-border bold-text">
                    <label class="white-text" for="wheels_count_uid">Wheel's count</label>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <input disabled value="0" id="donation_change_uid" type="number"
                        class="white-text input-bottom-border bold-text">
                    <label class="white-text" for="donation_change_uid">Donation change</label>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <input disabled id="next_wheel_price_uid" type="number"
                        class="white-text input-bottom-border bold-text">
                    <label class="white-text" for="next_wheel_price_uid">Next wheel price</label>
                </div>
            </div>
        </form>
    </div>

    <script type="text/javascript" src="js/materialize.min.js"></script>
    <script type="text/javascript" src="js/jquery-3.7.1.min.js"></script>

    <script>
        const WHEEL_START_PRICE = 500
        const WHEEL_PRICE_INCREMENT = 500
        const MIDAS_HAND_WHEEL_PRICE = 1500
        const MIDAS_HAND_START_CHARGES = 3

        class DonationWheelsData {
            constructor(wheelsCount, donationChange, nextWheelPrice) {
                this.wheelsCount = wheelsCount
                this.donationChange = this.tryGetDonationChangeValue(donationChange)
                this.nextWheelPrice = nextWheelPrice
            }

            tryGetDonationChangeValue(inDonationChange) {
                if (inDonationChange == "") {
                    return 0
                } else {
                    return inDonationChange
                }
            }
        }

        class DonationMidasBonus {
            constructor(isActive) {
                if (isActive) {
                    this.charges = MIDAS_HAND_START_CHARGES
                } else {
                    this.charges = 0
                }
            }

            tryUseCharges() {
                return this.charges-- > 0
            }

            hasCharges() {
                return this.charges > 0
            }
        }

        document.getElementById("check_button_uid").addEventListener("click", function () {
            let donationAmount = document.getElementById("donation_amount_uid").value
            let currWheelsCount = document.getElementById("curr_donation_wheels_count_uid").value
            let donationData = calculateWheelsCount(donationAmount, currWheelsCount)

            document.getElementById("wheels_count_uid").value = donationData.wheelsCount
            document.getElementById("donation_change_uid").value = donationData.donationChange
            document.getElementById("next_wheel_price_uid").value = donationData.nextWheelPrice
        });

        document.addEventListener('DOMContentLoaded', setDefaultNextWheelPrice);

        document.getElementById("curr_donation_wheels_count_uid").addEventListener("change", setDefaultNextWheelPrice)
        document.getElementById("midas_uid").addEventListener("change", setDefaultNextWheelPrice)

        function calculateWheelsCount(inDonationAmount, inCurrWheelsCount) {
            let midas = new DonationMidasBonus(isMidasActive())

            let donationLeft = inDonationAmount
            let wheelsCount = inCurrWheelsCount
            let wheelPrice = midas.tryUseCharges() ? MIDAS_HAND_WHEEL_PRICE : getActualWheelPrice(wheelsCount)
            let wasLastMidasCharge = !midas.hasCharges()

            while (donationLeft >= wheelPrice) {
                wheelsCount++
                donationLeft -= wheelPrice

                if (midas.tryUseCharges()) {
                    wheelPrice = MIDAS_HAND_WHEEL_PRICE
                } else if (!wasLastMidasCharge) {
                    wasLastMidasCharge = true
                    wheelPrice = WHEEL_START_PRICE
                } else if (wasLastMidasCharge) {
                    wheelPrice += WHEEL_PRICE_INCREMENT
                }
            }

            return new DonationWheelsData(wheelsCount, donationLeft, wheelPrice)
        }

        function isMidasActive() {
            return document.getElementById("midas_uid").checked
        }

        function getActualWheelPrice(wheelCount) {
            return WHEEL_START_PRICE + wheelCount * WHEEL_PRICE_INCREMENT
        }

        function setDefaultNextWheelPrice() {
            let wheelCount = document.getElementById("curr_donation_wheels_count_uid").value
            let nextWheelPrice = isMidasActive() ? MIDAS_HAND_WHEEL_PRICE : getActualWheelPrice(wheelCount)
            document.getElementById("next_wheel_price_uid").value = nextWheelPrice
        }

    </script>

</body>

</html>